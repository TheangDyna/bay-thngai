name: Deploy Project Infrastructure
on:
  push:
    branches: [deploy]
    paths:
      - "terraform/**"
permissions:
  contents: read
  actions: write
concurrency:
  group: terraform-deploy-${{ github.ref }}
  cancel-in-progress: true
jobs:
  deploy-infra:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8
      - name: Check for Existing Lock
        working-directory: terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-southeast-2
        run: |
          LOCK_ID=$(aws dynamodb get-item \
            --table-name terraform-locks \
            --key '{"LockID":{"S":"terraform-state-bucket-ap-southeast-2-390402568377/baythngai/v-1/terraform.tfstate"}}' \
            --query 'Item.LockID.S' --output text 2>/dev/null || echo "")
          if [ ! -z "$LOCK_ID" ]; then
            echo "Releasing lock: $LOCK_ID"
            terraform force-unlock $LOCK_ID || true
          fi
      - name: Terraform Init
        working-directory: terraform
        run: terraform init -backend-config="key=baythngai/v-1/terraform.tfstate" -input=false
      - name: Terraform Plan
        working-directory: terraform
        env:
          TF_VAR_mongo_uri: ${{ secrets.MONGO_URI }}
          TF_VAR_cognito_user_pool_id: ${{ secrets.AWS_COGNITO_USER_POOL_ID }}
          TF_VAR_cognito_client_id: ${{ secrets.AWS_COGNITO_CLIENT_ID }}
          TF_VAR_cognito_client_secret: ${{ secrets.AWS_COGNITO_CLIENT_SECRET }}
          TF_VAR_cognito_domain: ${{ secrets.AWS_COGNITO_DOMAIN }}
          TF_VAR_key_name: ${{ secrets.EC2_KEY_NAME }}
          TF_VAR_aws_redirect_uri: ${{ secrets.AWS_REDIRECT_URI }}
          TF_VAR_aws_s3_bucket_name: ${{ secrets.AWS_S3_BUCKET_NAME }}
          TF_VAR_aba_merchant_id: ${{ secrets.ABA_MERCHANT_ID }}
          TF_VAR_aba_public_key: ${{ secrets.ABA_PUBLIC_KEY }}
          TF_VAR_aba_endpoint: ${{ secrets.ABA_ENDPOINT }}
          TF_VAR_backend_callback_url: "https://api.baythngai.shop/api/v1/payment/callback"
          TF_VAR_frontend_return_success_url: "https://client.baythngai.shop/payment-return"
          TF_VAR_frontend_return_cancel_url: "https://client.baythngai.shop/payment-cancel"
          TF_VAR_vapid_public_key: ${{ secrets.VAPID_PUBLIC_KEY }}
          TF_VAR_vapid_private_key: ${{ secrets.VAPID_PRIVATE_KEY }}
        run: terraform plan -lock-timeout=10m
      - name: Terraform Apply
        if: github.ref == 'refs/heads/deploy'
        working-directory: terraform
        env:
          TF_VAR_mongo_uri: ${{ secrets.MONGO_URI }}
          TF_VAR_cognito_user_pool_id: ${{ secrets.AWS_COGNITO_USER_POOL_ID }}
          TF_VAR_cognito_client_id: ${{ secrets.AWS_COGNITO_CLIENT_ID }}
          TF_VAR_cognito_client_secret: ${{ secrets.AWS_COGNITO_CLIENT_SECRET }}
          TF_VAR_cognito_domain: ${{ secrets.AWS_COGNITO_DOMAIN }}
          TF_VAR_key_name: ${{ secrets.EC2_KEY_NAME }}
          TF_VAR_aws_redirect_uri: ${{ secrets.AWS_REDIRECT_URI }}
          TF_VAR_aws_s3_bucket_name: ${{ secrets.AWS_S3_BUCKET_NAME }}
          TF_VAR_aba_merchant_id: ${{ secrets.ABA_MERCHANT_ID }}
          TF_VAR_aba_public_key: ${{ secrets.ABA_PUBLIC_KEY }}
          TF_VAR_aba_endpoint: ${{ secrets.ABA_ENDPOINT }}
          TF_VAR_backend_callback_url: "https://api.baythngai.shop/api/v1/payment/callback"
          TF_VAR_frontend_return_success_url: "https://client.baythngai.shop/payment-return"
          TF_VAR_frontend_return_cancel_url: "https://client.baythngai.shop/payment-cancel"
          TF_VAR_vapid_public_key: ${{ secrets.VAPID_PUBLIC_KEY }}
          TF_VAR_vapid_private_key: ${{ secrets.VAPID_PRIVATE_KEY }}
        run: terraform apply -auto-approve -lock-timeout=10m
